name: Deploy Allure Report to GitHub Pages

# Gatilho alterado para ouvir o evento do outro repositório
on:
  repository_dispatch:
    types: [run-tests-after-deploy]

permissions:
  contents: read   # GITHUB_TOKEN só leitura, pois a org limita

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest
    
    steps:

        # --- NOVO PASSO ADICIONADO ---
    - name: Exibir informações do deploy
      run: |
        echo "Pipeline de testes disparada pelo repositório da aplicação!"
        echo "Autor do deploy: ${{ github.event.client_payload.author }}"
        echo "Branch de origem: ${{ github.event.client_payload.branch }}"
        # Você pode salvar essas informações em um arquivo ou variável de ambiente
        # para usar posteriormente na geração do relatório Allure
        echo "AUTOR_DO_DEPLOY=${{ github.event.client_payload.author }}" >> $GITHUB_ENV
        echo "BRANCH_DE_ORIGEM=${{ github.event.client_payload.branch }}" >> $GITHUB_ENV

    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
        
    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-
          
    - name: Restore dependencies
      run: dotnet restore

    - name: Build tests project
      run: dotnet build --configuration Debug --no-restore

    - name: Install Playwright browsers
      run: pwsh ./bin/Debug/net8.0/playwright.ps1 install --with-deps
      
    - name: Clean previous Allure results
      run: rm -rf allure-results || true
      
    - name: Run tests
      continue-on-error: true
      env:
        ZCUSTODIA_EMAIL: ${{ secrets.ZCUSTODIA_EMAIL }}
        ZCUSTODIA_PASS: ${{ secrets.ZCUSTODIA_PASS }}
      run: |
        if [ -d "allure-results" ]; then
          rm -rf allure-results
        fi
        dotnet test --configuration Debug --logger "console;verbosity=detailed"
        
    - name: Setup Node.js for Allure
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install Allure Commandline
      run: npm install -g allure-commandline
      
    - name: Generate Allure Report
      run: |
        if [ -d "allure-results" ]; then
          allure generate allure-results --clean -o allure-report
        else
          echo "No allure-results directory found"
          exit 1
        fi
        
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v4
      # A linha de condição foi removida, pois o fluxo agora é sob demanda.
      with:
        personal_token: ${{ secrets.ACTIONS_DEPLOY_TOKEN }}
        publish_dir: ./allure-report
        keep_files: false
        force_orphan: true
     - name: Send email with report link
      # Este passo sempre será executado, mesmo que os testes falhem.
      if: always()
      uses: dawidd6/action-send-mail@v3
      with:
        # Configure as credenciais do seu servidor SMTP usando secrets
        server_address: ${{ secrets.SMTP_SERVER }}
        server_port: ${{ secrets.SMTP_PORT }}
        username: ${{ secrets.SMTP_USER }}
        password: ${{ secrets.SMTP_PASS }}
        subject: "Relatorio Allure (Staging) Do autor: ${{ env.AUTOR_DO_DEPLOY }} da branch: ${{ env.BRANCH_DE_ORIGEM }} do zCustodia - ${{ job.status }}"
        to: ${{ secrets.MAIL_TO }}
        from: ${{ secrets.MAIL_FROM }}
        # Corpo do e-mail em formato HTML para ficar mais bonito
        html_body: |
          <p>Olá!</p>
          <p>A pipeline de testes foi executada com o status: <strong>${{ job.status }}</strong>.</p>
          <ul>
            <li>Autor do deploy: <strong>${{ env.AUTOR_DO_DEPLOY }}</strong></li>
            <li>Branch de origem: <strong>${{ env.BRANCH_DE_ORIGEM }}</strong></li>
            <li>ID da Workflow: <strong>${{ github.run_id }}</strong></li>
          </ul>
          <p>Você pode acessar o relatório completo no link abaixo:</p>
          <p><a href="${{ secrets.SITE_URL }}">Ver Relatório Allure</a></p>
          <br>
          <p>Atenciosamente,<br>GitHub Actions Bot</p>