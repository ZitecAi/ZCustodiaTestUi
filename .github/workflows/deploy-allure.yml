name: Deploy Allure Report to GitHub Pages

# Gatilho alterado para ouvir o evento do outro repositório
on:
  repository_dispatch:
    types: [run-tests-after-deploy]

permissions:
  contents: read   # GITHUB_TOKEN só leitura, pois a org limita

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest
    
    steps:

        # --- NOVO PASSO ADICIONADO ---
    - name: Exibir informações do deploy
      run: |
        echo "Pipeline de testes disparada pelo repositório da aplicação!"
        echo "Autor do deploy: ${{ github.event.client_payload.author }}"
        echo "Branch de origem: ${{ github.event.client_payload.branch }}"
        # Você pode salvar essas informações em um arquivo ou variável de ambiente
        # para usar posteriormente na geração do relatório Allure
        echo "AUTOR_DO_DEPLOY=${{ github.event.client_payload.author }}" >> $GITHUB_ENV
        echo "BRANCH_DE_ORIGEM=${{ github.event.client_payload.branch }}" >> $GITHUB_ENV

    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
        
    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-
          
    - name: Restore dependencies
      run: dotnet restore

    - name: Build tests project
      run: dotnet build --configuration Debug --no-restore

    - name: Install Playwright browsers
      run: pwsh ./bin/Debug/net8.0/playwright.ps1 install --with-deps
      
    - name: Clean previous Allure results
      run: rm -rf allure-results || true
      
    - name: Run tests
      continue-on-error: true
      env:
        ZCUSTODIA_EMAIL: ${{ secrets.ZCUSTODIA_EMAIL }}
        ZCUSTODIA_PASS: ${{ secrets.ZCUSTODIA_PASS }}
      run: |
        if [ -d "allure-results" ]; then
          rm -rf allure-results
        fi
        dotnet test --configuration Debug --logger "console;verbosity=detailed"
        
    - name: Setup Node.js for Allure
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install Allure Commandline
      run: npm install -g allure-commandline
      
    - name: Generate Allure Report
      run: |
        if [ -d "allure-results" ]; then
          allure generate allure-results --clean -o allure-report
        else
          echo "No allure-results directory found"
          exit 1
        fi
        
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v4
      # A linha de condição foi removida, pois o fluxo agora é sob demanda.
      with:
        personal_token: ${{ secrets.ACTIONS_DEPLOY_TOKEN }}
        publish_dir: ./allure-report
        keep_files: false
        force_orphan: true

    - task: PowerShell@2
    condition: always()
    env:
      SITE_URL: $(SITE_URL)
      SMTP_SERVER: $(SMTP_SERVER)
      SMTP_PORT: $(SMTP_PORT)
      SMTP_USER: $(SMTP_USER)
      SMTP_PASS: $(SMTP_PASS)
      MAIL_FROM: $(MAIL_FROM)
      MAIL_TO: $(MAIL_TO)
      TEST_EXIT: $(TEST_EXIT)
      BUILD_DEFINITIONNAME: $(Build.DefinitionName)
      BUILD_BUILDID: $(Build.BuildId)
      BUILD_BUILDNUMBER: $(Build.BuildNumber)
    inputs:
      targetType: inline
      script: |
        $siteUrl = $env:SITE_URL
        $pipeline = $env:BUILD_DEFINITIONNAME
        $buildId  = $env:BUILD_BUILDID
        $buildNum = $env:BUILD_BUILDNUMBER
        $testExit = $env:TEST_EXIT

        if ($testExit -ne "0") { $status = "COM FALHAS" } else { $status = "SUCESSO" }
        $subject = "Relatorio Allure (Staging) Do autor: $AUTOR_DO_DEPLOY da branch: $BRANCH_DE_ORIGEM do zCustodia - $status"

        $body = "Pipeline: $pipeline`nExecucao: $buildNum (ID $buildId)`nStatus dos testes: $status (exit $testExit)`nRelatorio: $siteUrl"

        $recipients = $env:MAIL_TO -split '[,;]' | ForEach-Object { $_.Trim() } | Where-Object { $_ }

        if ($env:SMTP_USER -and $env:SMTP_PASS) {
        $sec  = ConvertTo-SecureString $env:SMTP_PASS -AsPlainText -Force
        $cred = New-Object System.Management.Automation.PSCredential($env:SMTP_USER, $sec)
        Send-MailMessage -From $env:MAIL_FROM -To $recipients -Subject $subject -Body $body -SmtpServer $env:SMTP_SERVER -Port ([int]$env:SMTP_PORT) -UseSsl -Credential $cred -Encoding UTF8
        } else {
        Send-MailMessage -From $env:MAIL_FROM -To $recipients -Subject $subject -Body $body -SmtpServer $env:SMTP_SERVER -Port ([int]$env:SMTP_PORT) -Encoding UTF8
        }
    displayName: 'Send email with report link'